---
title: "Fit GAMs to Ascocyta blight spatiotemporal development data"
author: "Ihsan Khaliq"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fit GAMs to Ascocyta blight spatiotemporal development data}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
  %\VignetteDepends{broom}
  %\VignetteDepends{mgcv}
  %\VignetteDepends{ggpubr}
  %\VignetteDepends{lubridate}
  %\VignetteDepends{tidyverse}
   %\VignetteDepends{SDMTools}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
knitr::opts_chunk$set(progress = TRUE, verbose = TRUE)
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 7,
  fig.height = 7,
  fig.align = "center"
)
```
## Load libraries 

```{r libraries, message=FALSE, echo=TRUE, warning=FALSE}
library("readxl")
library("mgcv")
library("broom")
library("ggpubr")
library("tidyverse")
library("lubridate")
library("spatiotemporaldynamics")
library("SDMTools")
```

## Import data

### Disease spread data

Import disease data.

```{r import-disease-data}
### import spatiotemporal spread data
dat <-
  read_excel(
    system.file("extdata", "SpatioTemporalSpreadData.xlsx",
                package = "spatiotemporaldynamics"),
    sheet = 1,
    na = "NA"
  )

summary(dat)
```

### Daily average wind direction data

```{r import-wind_data}
wind <- 
  read_excel(
      system.file("extdata", "DailyWindDirectionData.xlsx",
                  package = "spatiotemporaldynamics"),
      sheet = 1
   )

summary(wind)
```

## Convert text to degrees

Wind direction for the Billa Billa site is the character format recorded as the text value of the wind direction.
We need to convert it to degrees for calculations and then calculate the fortnightly average wind direction for use in the GAMs.

```{r convert-text-to-degrees}
wind <-
  wind %>%
  mutate(wind_degrees = as.numeric(
    case_when(
      daily_avg_wind_direction == "N" ~ "0",
      daily_avg_wind_direction == "NbE" ~ "11.25",
      daily_avg_wind_direction == "NNE" ~ "22.5",
      daily_avg_wind_direction == "NEbN" ~ "33.75",
      daily_avg_wind_direction == "NE" ~ "45",
      daily_avg_wind_direction == "NEbE" ~ "56.25",
      daily_avg_wind_direction == "ENE" ~ "67.5",
      daily_avg_wind_direction == "EbN" ~ "73.5",
      daily_avg_wind_direction == "E" ~ "90",
      daily_avg_wind_direction == "EbS" ~ "101.2",
      daily_avg_wind_direction == "ESE" ~ "112.5",
      daily_avg_wind_direction == "SEbE" ~ "123.8",
      daily_avg_wind_direction == "SE" ~ "135.1",
      daily_avg_wind_direction == "SEbS" ~ "146.3",
      daily_avg_wind_direction == "SSE" ~ "157.6",
      daily_avg_wind_direction == "SbE" ~ "168.8",
      daily_avg_wind_direction == "S" ~ "180",
      daily_avg_wind_direction == "SbW" ~ "191.2",
      daily_avg_wind_direction == "SSW" ~ "202.5",
      daily_avg_wind_direction == "SWbS" ~ "213.8",
      daily_avg_wind_direction == "SW" ~ "225",
      daily_avg_wind_direction == "SWbW" ~ "236.2",
      daily_avg_wind_direction == "WSW" ~ "247.5",
      daily_avg_wind_direction == "WbS" ~ "258.8",
      daily_avg_wind_direction == "W" ~ "270",
      daily_avg_wind_direction == "WbN" ~ "281.2",
      daily_avg_wind_direction == "WNW" ~ "292.5",
      daily_avg_wind_direction == "NWbW" ~ "303.8",
      daily_avg_wind_direction == "NW" ~ "315",
      daily_avg_wind_direction == "NWbN" ~ "326.2",
      daily_avg_wind_direction == "NNW" ~ "337.5",
      daily_avg_wind_direction == "NbW" ~ "348.8",
      TRUE ~   daily_avg_wind_direction
    )
  )) %>%
  group_by(location, assessment_number) %>%
  summarise(wind_direction = circular.averaging(wind_degrees))
```

## Join the data sources

Left-join the wind and disease data for analysis in the GAMs.

```{r}
dat <- left_join(dat, wind, by = c("location", "assessment_number"))
```

### Combine quadrat direction and location column to determine whether quadrats located in particular direction has significantly faster disease progress rates


```{r unite-location-quadrat-direction}
dat <-
  unite(dat, direc_loc, c(location, direction), remove = FALSE) 
```


## Examine data

```{r examine-data}
str(dat)
```

## Prepare data to fit GAMs

Assign variables to the correct classes.

```{r prepare-data}
cols_1 <- c("location", "quadrat", "direction", "direc_loc")
dat[cols_1] <- lapply(dat[cols_1], factor)
```

## Re-check class

```{r check-class}
sapply(dat, class)
```

## Fit univariate GAMs

Use `set.seed()` for reproducibility purposes.

```{r set-seed, echo=TRUE}
set.seed(42)
```

### Model_1 s(distance)

```{r fit-model_1}
model_1 <-
  gam(incidence ~ s(distance, k = 4),
      data = dat,
      method = "REML")

summary(model_1)

plot(
  model_1,
  pages = 1,
  residuals = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_1)[1]
)
```


### Model_2 s(total_rain)

```{r fit-model_2}
model_2 <-
  gam(incidence ~ s(total_rain, k = 16),
      data = dat,
      method = "REML")

summary(model_2)

plot(
  model_2,
  residuals = TRUE,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_2)[1]
)
```


### Model_3 assessment_number

```{r fit-model_3}
model_3 <-
  gam(incidence ~ assessment_number,
      data = dat,
      method = "REML")

summary(model_3)

plot(
  model_3,
  all.terms = TRUE,
  residuals = TRUE,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_3)
)
```


### Model_4 s(avg_wind_speed)

```{r fit-model_4}
model_4 <-
  gam(incidence ~ s(avg_wind_speed, k = 18),
      data = dat,
      method = "REML")

summary(model_4)

plot(
  model_4,
  residuals = TRUE,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_4)[1]
)
```

### Model_5 s(avg_rh)

```{r fit-model_5}
model_5 <-
  gam(incidence ~ s(avg_rh, k = 18),
      data = dat,
      method = "REML")

summary(model_5)

plot(model_5,
     residuals = TRUE,
     pages = 1,
     shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_5)[1])
```

### Model_6 s(avg _temp)

```{r fit-model_6}
model_6 <-
  gam(incidence ~ s(avg_temp, k = 18),
      data = dat,
      method = "REML")

summary(model_6)

plot(
  model_6,
  residuals = TRUE,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_6)[1]
)
```

### Model_6.1 s(avg _temp, by = location)

```{r fit-model_6.1}
model_6.1 <-
  gam(incidence ~ s(avg_temp, by = location, k = 18),
      data = dat,
      method = "REML")

summary(model_6.1)

plot(
  model_6.1,
  residuals = TRUE,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_6.1)[1]
)
```


### Model_7 location

```{r fit-model_7}
model_7 <-
  gam(incidence ~ location,
      data = dat,
      method = "REML")

summary(model_7)

plot(
  model_7,
  residuals = TRUE,
  all.terms = TRUE,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_7)[1]
)
```

## Fit multivariate GAMs

### Model_8 (All variables)

```{r fit-model_8}
model_8 <-
  gam(
    incidence ~ s(total_rain, k = 16) +
      s(distance, k = 4) +
      s(avg_wind_speed, k = 18) +
      s(avg_rh, k = 18) +
      s(avg_temp, k = 18) +
      s(wind_direction, k = 18) +
      location +
      assessment_number +
      direc_loc,
    data = dat,
    method = "REML"
  )

summary(model_8)

plot(
  model_8,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_8)[1]
)
```

### Model_9 (Fit different smooths for each term by location)

Same as `model_8` but different smooths have been considered for each term BY LOCATION

```{r fit-model_9}
model_9 <-
  gam(
    incidence ~ s(total_rain, k = 16, by = location) +
      s(distance, k = 4, by = location) +
      s(avg_wind_speed, k = 18, by = location) +
      s(avg_temp, k = 18, by = location) +
      s(avg_rh, k = 18, by = location) +
      s(wind_direction, k = 18, by = location) +
      assessment_number +
      location +
      direc_loc,
    data = dat,
    method = "REML"
  )

summary(model_9)

plot(
  model_9,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_9)[1]
)
```

### Comments on model_9

Fitting different smooths for each term by location in `model_9` improved the adjusted R^2 and percent deviance explained values.
Noam Ross encourages this practice in his own words,

> "We can also specify a GAM formula that will fit different smooths for different categorical variables. We call this a factor-smooth interaction. By specifying the 'by' argument to the s() function, we can tell R to calculate a different smooth for each unique category. Usually, when we have smooth-factor interactions, we want to also include a varying intercept, in case the different categories are different in overall means in addition to shape of their smooths. Here, you see adding this varying intercept improves the estimate of the smooth. Usually, when we have smooth-factor interactions, we want to also include a varying intercept, in case the different categories are different in overall means in addition to shape of their smooths"


### Model_10

Same as `model_8` but relative humidity, wind speed and wind direction removed, as they were not significant.

```{r fit-model_10}
model_10 <-
  gam(
    incidence ~ s(total_rain, k = 16) +
      s(distance, k = 4) +
      s(avg_wind_speed, k = 18) +
      location +
      assessment_number +
      direc_loc,
    data = dat,
    method = "REML"
  )

summary(model_10)

plot(
  model_10,
  pages = 1,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_10)[1]
)
```

## Compare the models

### AIC, BIC

```{r compare-models}
models <- list(
  model_1 = model_1,
  model_2 = model_2,
  model_3 = model_3,
  model_4 = model_4,
  model_5 = model_5,
  model_6 = model_6,
  model_6.1 = model_6.1,
  model_7 = model_7,
  model_8 = model_8,
  model_9 = model_9,
  model_10 = model_10
 )
map_df(models, glance, .id = "model") %>%
  arrange(AIC)
```

### R^2^

```{r r2}
enframe(
  c(
    model_1 = summary(model_1)$r.sq,
    model_2 = summary(model_2)$r.sq,
    model_3 = summary(model_3)$r.sq,
    model_4 = summary(model_4)$r.sq,
    model_5 = summary(model_5)$r.sq,
    model_6 = summary(model_6)$r.sq,
    model_6.1 = summary(model_6.1)$r.sq,
    model_7 = summary(model_7)$r.sq,
    model_8 = summary(model_8)$r.sq,
    model_9 = summary(model_9)$r.sq,
    model_10 = summary(model_10)$r.sq
  )
) %>%
  arrange(desc(value))
```

### ANOVA

```{r anova}
anova(
  model_1,
  model_2,
  model_3,
  model_4,
  model_5,
  model_6,
  model_6.1,
  model_7,
  model_8,
  model_9,
  model_10
 )
```

## Perform checks on the best fitting `model_9`

### gam.check and concurvity

```{r check-model_9}
gam.check(model_9)
```


### Comments on the model check

The model has been fully converged, which indicates that there is no issue of too many variables for not enough data.
However, the model fit could have been much better if we had enough basis function for predictors showing significant result in the diagnostic function, the low p value means residuals are not randomly distributed).


```{r concurvity-10}
concurvity(model_9, full=TRUE)
```


## Final thoughts

The `model_9` seems to be the best fit model and adequately describes the spatiotemporal development of Ascochyta blight of chickpea 



