---
title: "Spatial dynamics of Ascocyta rabiei"
author: "Ihsan Khaliq"
date: "`r Sys.Date()`"
output:rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Spatial dynamics of Ascocyta blight}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
knitr::opts_chunk$set(progress = TRUE, verbose=TRUE)
```

## Load libraries 

```{r libraries, message=FALSE, echo=TRUE, warning=FALSE}
library("readxl")
library("mgcv")
library("broom")
library("ggpubr")
library("tidyverse")
library("mgcViz")
library("lubridate")
```

## Import data

```{r import data}
spatial_dat <- read_excel("SpatioTemporalSpreadData.xlsx", sheet = 2)

```

## Examine data

```{r examine data}
head(spatial_dat)
str(spatial_dat)
```

## Prepare data to fit GAMs

```{r prepare data}
cols_1 <- c("location","quadrat", "direction")
spatial_dat[cols_1] <- lapply(spatial_dat[cols_1], factor)

```

## Re-check class

```{r check class}
sapply(spatial_dat, class)
```

## Fit univariate GAMs

Use 'set.seed()' for reproducibility purposes

```{r set seed, echo=TRUE}
set.seed(30)
```

### Model_1 s(distance)

```{r fit model_1}
model_1 <-
  gam(incidence ~ s(distance, k = 10),
      data = spatial_dat,
      method = "REML")

summary(model_1)

plot(
  model_1,
  pages = 1,
  residuals = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_1) [1]
)

```


### Model_2 -s(total_rain)

```{r fit model_2}
model_2 <-
  gam(incidence ~ s(total_rain, k = 3),
      data = spatial_dat,
      method = "REML")

summary(model_2)

plot(
  model_2,
  pages = 1,
  residuals = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_1) [1]
)
```

### Model_2.1 -s(total_rain, by=location)

```{r fit model 2.1}
model_2.1 <-
  gam(incidence ~ s(total_rain, k = 3, by = location),
      data = spatial_dat,
      method = "REML")

summary(model_2.1)

plot(
  model_2.1,
  pages = 1,
  residuals = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_2.1) [1]
)

```




### Comments on model_2 and model_2.1

The variable `total_rain` should have shown a linear trend. Upon closer inspection of data, rainfall amount increased gradually with time at Billa Billa. However, this wasn't the case at Tosari, where more rain occurred at the beginning, less frequent at the middle season and then one final big rain occurred towards the end of the season. It should a bell shape trend for Tosari, not downward trend though?  

### Model_3 assessment_number

```{r fit model_3}
model_3 <-
  gam(incidence ~ assessment_number,
      data = spatial_dat,
      method = "REML")

summary(model_3)

plot(
  model_3,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_3) [1]
)

```


### Model_4 s(avg_wind_speed)

```{r fit model_4}
model_4 <-
  gam(incidence ~ s(avg_wind_speed, k = 3),
      data = spatial_dat,
      method = "REML")

summary(model_4)

plot(
  model_4,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_4) [1]
)
```


### Model_4.1 s(avg_wind_speed, by=location)

```{r fit model 4.1}
model_4.1 <-
  gam(incidence ~ s(avg_wind_speed, k = 3, by = location),
      data = spatial_dat,
      method = "REML")

summary(model_4.1)

plot(
  model_4.1,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_4.1) [1]
)
```

### Comments on model 4 and 4.1

By looking at the plots of both models, the relationship seem very complex in `model_4`.The `model 4.1` shows that `avg_wind_speed` has more influence at `Billa Billa`. We had only two assessments for spatial spread - more assessments are required to accurately determine data patterns

### Model_5 s(avg_rh)

```{r fit model_5}
model_5 <-
  gam(incidence ~ s(avg_rh, k = 3, by=location),
      data = spatial_dat,
      method = "REML")

summary(model_5)

plot(
  model_5,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_5) [1]
)
```

### Model_6 s(avg _temp)

```{r fit model_6}
model_6 <-
  gam(incidence ~ s(avg_temp, k=3),
      data = spatial_dat,
      method = "REML")

summary(model_6)

plot(
  model_6,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_6) [1]
)
```

### Model_6.1 s(avg _temp, by = location)

```{r fit model 6.1}
model_6.1 <-
  gam(incidence ~ s(avg_temp, by=location, k=3),
      data = spatial_dat,
      method = "REML")

summary(model_6.1)

plot(
  model_6.1,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  shade.col = "lightblue",
  seWithMean = TRUE,
  shift = coef(model_6.1) [1]
)
```


### Model_7 ~location

```{r fit model_7 location}
model_7 <-
  gam(incidence ~ location,
      data = spatial_dat,
      method = "REML")

summary(model_7)

plot(
  model_7,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  shade.col = "lightblue",
  seWithMean = TRUE,
  shift = coef(model_7) [1]
)
```

### Model 7.1 ~direction

Please note that direction `NA` refers to 0 metre distance.

```{r fit model 7.1}
model_7.1 <-
  gam(incidence ~ direction, by=location,
      data = spatial_dat,
      method = "REML")

summary(model_7.1)

plot(
  model_7.1,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  shade.col = "lightblue",
  seWithMean = TRUE,
  shift = coef(model_7.1) [1]
)
```



## Fit multivariate GAMs

### Model_8 (All variables)

```{r fit model 8}
model_8 <-
  gam(
    incidence ~ s(total_rain, k=3) + s(distance, k=10) + s(avg_wind_speed, k=3) 
    + s(avg_rh, k=3) + s(avg_temp, k=3) + location + assessment_number + direction,
    data = spatial_dat,
    method = "REML"
  )

summary(model_8)

plot(
  model_8,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  shade.col = "lightblue",
  seWithMean = TRUE,
  shift = coef(model_8) [1]
)
```



### Model_9 (Fit different smooths for each term by location)

```{r fit model 9}
model_9 <-
  gam(
    incidence ~ s(total_rain, k=3, by=location) + s(distance, k=10, by=location) + s(avg_wind_speed, k=3, by=location) 
    + s(avg_rh, k=3, by=location) + s(avg_temp, k=3, by=location) + assessment_number + direction, by=location + location,
    data = spatial_dat,
    method = "REML"
  )

summary(model_9)

plot(model_9,
     all.terms = TRUE,
     pages = 1)
```

### Comments on model_8 and model_9

By fitting different smooths for each term by location, `total_rain` , `avg_wind_speed` and `avg_rh` are no longer significant in model_9, but adjusted R^2 and Deviance explained values got improved


### Model_ 10 (Remove `avg_rh`)

```{r fit model 10}
model_10 <-
  gam(
    incidence ~ s(total_rain, k=3, by=location) + s(distance, k=10, by=location) + s(avg_wind_speed, k=3, by=location) 
    + s(avg_temp, k=3, by=location) + direction + assessment_number + location,
    data = spatial_dat,
    method = "REML"
  )

summary(model_10)

plot(model_10,
     all.terms = TRUE,
     pages = 1)
```


### Model 11 (All variables minus avg_temp)

```{r fit model_11}
model_11 <-
  gam(
    incidence ~ s(total_rain, k=3) + s(distance, k=10) + s(avg_wind_speed, k=3) 
  +  s(avg_rh, k=3) + location + assessment_number + direction,
    data = spatial_dat,
    method = "REML"
  )

summary(model_11)

plot(
  model_11,
  pages = 1,
  residuals = TRUE,
  all.terms = TRUE,
  shade = TRUE,
  seWithMean = TRUE,
  shift = coef(model_11) [1]
)
```


### Model_ 12 (Interaction between `total_rain` and `avg_wind_speed` by location)

```{r fit model 12}
model_12 <-
  gam(
    incidence ~ s(total_rain, avg_wind_speed, k=3, by=location) + s(distance, k=10, by=location) +  s(avg_temp, k=3, by=location) + assessment_number + location + direction,
    data = spatial_dat,
    method = "REML"
  )

summary(model_12)
plot(model_12,  scheme = 1, pages = 1)

```



### Visualize the interaction between `avg_wind_speed` and `total_rain` of model_13


```{r visualise interaction}
vis.gam(x=model_12,
     view = c("total_rain", "avg_wind_speed"),
     plot.type = "persp",
     theta = 135
   )
```

### Add confidence interval to the interaction visualisation/predictions

```{r add CI to the visualisation}
vis.gam(x=model_12,
     view = c("total_rain", "avg_wind_speed"),
     plot.type = "persp",
     se=2, theta=135)
```

The plot indicates the number of standard errors (2 in this case) away from the average prediction to plot high and low prediction surfaces 

### Model_ 14 (Interaction between `total_rain` and `avg_wind_speed` NOT by location)

```{r fit model 13}
model_13 <-
  gam(
    incidence ~ s(total_rain, avg_wind_speed, k=3) + s(distance, k=10)  
  +  s(avg_rh, k=3) + location + assessment_number + direction,
    data = spatial_dat,
    method = "REML"
  )


summary(model_13)
plot(model_14, all.terms=TRUE, scheme = 1, pages = 1)

```


### Model_ 14 (Try Tensor interaction between `total_rain` and `avg_wind_speed` NOT by location)

```{r}
model_14 <-
  gam(
    incidence ~ ti(total_rain, avg_wind_speed, k=3) + s(distance, k=10)  
  +  s(avg_rh, k=3) + location + assessment_number + direction,
    data = spatial_dat,
    method = "REML"
  )

summary(model_14)
plot(model_15, all.terms=TRUE, scheme = 1, pages = 1)

```



## Compare the models

### AIC, BIC

```{r compare the models}
models <- list(
  model_1 = model_1,
  model_2 = model_2,
  model_3 = model_3,
  model_4 = model_4,
  model_5 = model_5,
  model_6 = model_6,
  model_7 = model_7,
  model_8 = model_8,
  model_9 = model_9,
  model_10 = model_10,
  model_11 = model_11,
  model_12 = model_12,
  model_14 = model_14
)
map_df(models, glance, .id = "model") %>%
  arrange(AIC)
```

### R^2^

```{r r2}
enframe(
  c(
    model_1 = summary(model_1)$r.sq,
    model_2 = summary(model_2)$r.sq,
    model_3 = summary(model_3)$r.sq,
    model_4 = summary(model_4)$r.sq,
    model_4.1 = summary(model_4.1)$r.sq,
    model_5 = summary(model_5)$r.sq,
    model_6 = summary(model_6)$r.sq,
    model_6.1 = summary(model_6.1)$r.sq,
    model_7 = summary(model_7)$r.sq,
    model_8 = summary(model_8)$r.sq,
    model_9 = summary(model_9)$r.sq,
    model_10 = summary(model_10)$r.sq,
    model_11 = summary(model_11)$r.sq,
    model_12 = summary(model_12)$r.sq,
    model_14 = summary(model_14)$r.sq
  )
) %>%
  arrange(desc(value))
```

### ANOVA

```{r anova}
anova(
  model_1,
  model_2,
  model_3,
  model_4,
  model_4.1,
  model_5,
  model_6,
  model_6.1,
  model_7,
  model_8,
  model_9,
  model_10,
  model_11,
  model_12,
  model_13,
  model_14,
 test = "F")
  

```



## Perform checks on  best fitting model

### `gam.check()`
### Concurvity

```{r Check model_12}
gam.check(model_12)
```
### Concurvity

```{r Check concurvity}
concurvity(model_12, full = TRUE)
```

## Thoughts

Both `model_12` and `model_10` have same  AIC, BIC and adjusted R^2 values. Both rain and wind speed are not significant in model_10, but these are significant in model_12, therefore model 12 should be chosen because it makes more sense and will be easier to interpret in Results/Discussions. 
